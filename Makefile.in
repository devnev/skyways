#!/usr/bin/make
# @configure_input@

######################################
# configuration: change things here. #
######################################

PROGRAMS?=@programs@

SkywaysGlut_BINARY=skyways.glut
SkywaysQt_BINARY=skyways.qt
SkywaysSdl_BINARY=skyways.sdl

Common_HEADERS= \
	src/configuration.hpp \
	src/controller.hpp \
	src/display/shader.hpp \
	src/display/textprinter.hpp \
	src/display/uniform.hpp \
	src/game.hpp \
	src/loading/blockloader.hpp \
	src/loading/mapgenerator.hpp \
	src/loading/maploader.hpp \
	src/loading/objmodel.hpp \
	src/range.hpp \
	src/vector.hpp \
	src/world/aabb.hpp \
	src/world/block.hpp \
	src/world/collisionaccelerator.hpp \
	src/world/element.hpp \
	src/world/map.hpp \
	src/world/model.hpp \
	src/world/ship.hpp \
	#

SkywaysGlut_HEADERS= $(Common_HEADERS) \
	src/backends/configparser.hpp \
	#

SkywaysQt_HEADERS= $(Common_HEADERS) \
	src/backends/qtconfigparser.hpp \
	src/backends/qtwindow.hpp \
	#

SkywaysSdl_HEADERS= $(Common_HEADERS) \
	src/backends/configparser.hpp \
	#

Common_CXXSOURCES= \
	src/configuration.cpp \
	src/controller.cpp \
	src/display/shader.cpp \
	src/display/textprinter.cpp \
	src/game.cpp \
	src/loading/blockloader.cpp \
	src/loading/mapgenerator.cpp \
	src/loading/maploader.cpp \
	src/loading/objmodel.cpp \
	src/world/block.cpp \
	src/world/collisionaccelerator.cpp \
	src/world/element.cpp \
	src/world/map.cpp \
	src/world/ship.cpp \
	#

SkywaysGlut_CXXSOURCES= $(Common_CXXSOURCES) \
	src/backends/configparser.cpp \
	src/backends/glutmain.cpp \
	#

SkywaysQt_CXXSOURCES= $(Common_CXXSOURCES) \
	src/backends/qtconfigparser.cpp \
	src/backends/qtmain.cpp \
	src/backends/qtwindow.cpp \
	#

SkywaysSdl_CXXSOURCES= $(Common_CXXSOURCES) \
	src/backends/configparser.cpp \
	src/backends/sdlmain.cpp \
	#

CFLAGS:= @CFLAGS@ -Wall $(CFLAGS)
CXXFLAGS:= @CXXFLAGS@ -Wall $(CXXFLAGS)
CPPFLAGS:= @CPPFLAGS@ -Wall @FTGL_CFLAGS@ @BOOST_CPPFLAGS@ $(CPPFLAGS) -I@top_srcdir@/src
LDFLAGS:= @LDFLAGS@ @BOOST_LDFLAGS@ $(LDFLAGS)
LIBS:=@LIBS@ @FTGL_LIBS@ @BOOST_FILESYSTEM_LIB@ $(LIBS)

SkywaysGlut_LIBS=@GLUT_LIBS@ @BOOST_PROGRAM_OPTIONS_LIB@
SkywaysQt_CPPFLAGS=-D_REENTRANT -DQT_NO_DEBUG -DQT_OPENGL_LIB -DQT_GUI_LIB -DQT_CORE_LIB @QT_CFLAGS@
SkywaysQt_LIBS=@QT_LIBS@
SkywaysQt_OBJECTS=src/backends/moc_qtwindow_SkywaysQt.o
SkywaysSdl_CPPFLAGS=@SDL_CFLAGS@
SkywaysSdl_LIBS=@SDL_LIBS@ @BOOST_PROGRAM_OPTIONS_LIB@

EXTRADIST=configure.ac Makefile.in configure config.h.in aclocal.m4 \
		  shaders/shader.glslf shaders/shader.glslv DejaVuSans.ttf\
		  blocks/cube blocks/flat blocks/tunnel world \
		  COPYING README

VPATH=@top_srcdir@

######################################
# auto-configuration: do not change! #
######################################

CWD:=$(shell pwd)

default: all

$(foreach prog,$(PROGRAMS),$(eval $(prog)_ALL_SOURCES=$($(prog)_SOURCES) $($(prog)_CSOURCES) $($(prog)_CXXSOURCES)))
$(foreach prog,$(PROGRAMS),$(eval $(prog)_ALL_OBJECTS=$($(prog)_OBJECTS) $(patsubst %.c,%_$(prog).o,$($(prog)_CSOURCES)) $(patsubst %.cpp,%_$(prog).o,$($(prog)_CXXSOURCES))))
$(foreach prog,$(PROGRAMS),$(eval $(prog)_ALL_HEADERS=$($(prog)_HEADERS)))
$(foreach flag,CFLAGS CPPFLAGS CXXFLAGS LDFLAGS LIBS,$(foreach prog,$(PROGRAMS),$(eval $(prog)_ALL_$(flag)=$($(flag)) $($(prog)_$(flag)))))

SOURCES=$(foreach prog,$(PROGRAMS),$($(prog)_ALL_SOURCES))
HEADERS=$(foreach prog,$(PROGRAMS),$($(prog)_ALL_HEADERS))
OBJECTS=$(foreach prog,$(PROGRAMS),$($(prog)_ALL_OBJECTS))
BINARIES=$(foreach prog,$(PROGRAMS),$($(prog)_BINARY))
DEPENDS=$(patsubst %.o,%.d,$(OBJECTS))

define CDEP_template
  %_$(1).d: %.c $$($(1)_ALL_HEADERS)
	@mkdir -p "`dirname $$@`"
	@set -e; rm -f "$$@" || true; \
		$$(CC) -MM -MQ "`echo "$$@" | sed 's/\.d$$$$/.o'`" $$($(1)_ALL_CPPFLAGS) $$($(1)_ALL_CFLAGS) "$$<" > $$@
	@echo @ECHO_N@ ".@ECHO_C@"
endef

define CXXDEP_template
  %_$(1).d: %.cpp $$($(1)_ALL_HEADERS)
	@mkdir -p "`dirname $$@`"
	@set -e; rm -f "$$@" || true; \
		$$(CXX) -MM -MQ "`echo "$$<" | sed 's,\($$*\)\.cpp,\1_$(1).o,'`" $$($(1)_ALL_CPPFLAGS) $$($(1)_ALL_CXXFLAGS) "$$<" > $$@
	@echo @ECHO_N@ ".@ECHO_C@"
endef

define CSRC_template
  %_$(1).o: %.c
	$$(CC) -c $$($(1)_ALL_CPPFLAGS) $$($(1)_ALL_CFLAGS) $$< -o $$@
endef

define CXXSRC_template
  %_$(1).o: %.cpp
	$$(CXX) -c $$($(1)_ALL_CPPFLAGS) $$($(1)_ALL_CXXFLAGS) $$< -o $$@
endef

define BINARY_template
  $$($(1)_BINARY): $$($(1)_ALL_OBJECTS)
	$$(CC) $$($(1)_ALL_LDFLAGS) $$($(1)_ALL_LIBS) $$^ $$(LOADLIBS) $$(LDLIBS) -o $$@
endef

$(foreach template,CDEP CXXDEP CSRC CXXSRC BINARY,$(foreach prog,$(PROGRAMS),$(eval $(call $(template)_template,$(prog)))))

all: $(BINARIES)

# this rule is just to add a newline after the dots from deps calculation
Makefile: $(DEPENDS)
	@echo
	@touch $@

%.tar.gz:
	rm -f $@
	echo $(patsubst @top_srcdir@/%,%,$(filter @top_srcdir@/%,$^)) | tr ' ' '\n' | tar -C @top_srcdir@ -cf $(patsubst %.gz,%,$@) --files-from=-
	tar -rf $(patsubst %.gz,%,$@) $(filter-out @top_srcdir@/%,$^)
	gzip $(patsubst %.gz,%,$@)

@PACKAGE_TARNAME@.tar.gz: $(SOURCES) $(HEADERS) $(EXTRADIST)

DISTFILES=@PACKAGE_TARNAME@.tar.gz

dist: $(DISTFILES)

#################################
# extra stuff: change as needed #
#################################

AC_OUTPUT=configure config.h.in aclocal.m4
AC_OUTPUT_DIRS=autom4te.cache
CONFIG_OUTPUT=config.h Makefile config.log config.status

clean:
	rm -f $(OBJECTS) $(BINARIES) $(DEPENDS) $(DISTFILES) src/backends/moc_qtwindow.cpp || true

clean-config:
	rm -f $(CONFIG_OUTPUT) || true

clean-ac:
	rm -f $(AC_OUTPUT) || true
	rm -rf $(AC_OUTPUT_DIRS) || true

clean-full: clean clean-config clean-ac

moc_%.cpp: %.hpp
	moc-qt4 $(SkywaysQt_CPPFLAGS) $(SkywaysQt_CXXFLAGS) $< -o $@

.PHONY: default dist clean clean-config clean-ac clean-full

-include $(DEPENDS)
